<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Composer Management Interface</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 30px;
        }
        .gateway-card, .server-kit-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }
        .gateway-header, .server-kit-header, .server-header, .tool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .tool-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .gateway-name, .server-kit-name, .server-name {
            font-size: 1.1em;
            font-weight: 600;
        }
        .gateway-paths {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        .gateway-paths code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .endpoint-description {
            display: block;
            margin-top: 5px;
            font-style: italic;
        }
        .endpoint-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .copy-endpoint-btn {
            background-color: #f0f0f0;
            color: #333;
            padding: 3px 8px;
            font-size: 0.8em;
            border-radius: 3px;
            border: 1px solid #ccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .copy-endpoint-btn:hover {
            background-color: #e0e0e0;
        }
        .copy-endpoint-btn::before {
            content: "üìã"; /* Clipboard icon using emoji */
            font-size: 0.75em;
        }
        .details-section {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 3px solid #007bff;
            display: none; /* Initially hidden */
        }
        .details-section.expanded {
            display: block;
        }
        .server-card {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .tool-list {
            padding-left: 20px;
            margin-top: 10px;
            display: none; /* Initially hidden */
        }
        .tool-list.expanded {
            display: block;
        }
        .tool-item {
            padding: 8px 0;
            font-size: 0.95em;
            border-bottom: 1px dashed #eee; /* Dashed border for tools */
            margin-bottom: 5px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
            margin-left: 10px;
        }
        .status-enabled {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-disabled {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.2s, opacity 0.2s;
            /* margin-left: 5px; */ /* Remove margin-left */
        }
        .action-btn {
             background-color: #007bff;
             color: white;
             min-width: 90px; /* Set a minimum width */
             text-align: center; /* Center the text */
        }
         .action-btn:hover {
             background-color: #0056b3;
         }
        .copy-btn {
            background-color: #ffc107;
            color: #333;
            min-width: 90px; /* Set a minimum width */
            text-align: center; /* Center the text */
        }
        .copy-btn:hover {
            background-color: #e0a800;
        }
        .enable-btn {
            background-color: #28a745;
            color: white;
            min-width: 90px; /* Set a minimum width */
            text-align: center; /* Center the text */
        }
        .enable-btn:hover {
            background-color: #218838;
        }
        .disable-btn {
            background-color: #dc3545;
            color: white;
            min-width: 90px; /* Set a minimum width */
            text-align: center; /* Center the text */
        }
        .disable-btn:hover {
            background-color: #c82333;
        }
        button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .grayed-out {
            opacity: 0.5;
            pointer-events: none; /* Prevents interaction */
        }
        .grayed-out .action-btn, .grayed-out .enable-btn, .grayed-out .disable-btn {
             background-color: #adb5bd; /* Use a muted gray for buttons */
             cursor: not-allowed;
        }
        .loading, .no-data {
            text-align: center;
            padding: 30px;
            font-style: italic;
            color: #6c757d;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .notification.success { background-color: #28a745; }
        .notification.error { background-color: #dc3545; }
        .notification.show { opacity: 1; transform: translateY(0); }
        .button-loading {
            position: relative;
            color: transparent !important; /* Hide text */
            pointer-events: none; /* Disable clicks while loading */
        }
        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 3px solid rgba(255, 255, 255, 0.3); /* Lighter border */
            border-top-color: white;
            border-radius: 50%;
            animation: button-loading-spinner 1s linear infinite;
        }
        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }
        /* Style for toggle buttons */
        .toggle-details-btn {
             background: none;
             border: none;
             cursor: pointer;
             font-size: 1.2em;
             padding: 0 5px;
             color: #007bff;
        }
         .toggle-details-btn::before {
             content: '‚ñ∂'; /* Right-pointing triangle for collapsed */
             display: inline-block;
             margin-right: 5px;
             transition: transform 0.2s ease-in-out;
        }
         .toggle-details-btn.expanded::before {
             transform: rotate(90deg); /* Down-pointing triangle for expanded */
        }
        .gateway-header .button-group,
        .server-header .status-and-button-group,
        .tool-item .status-and-button-group {
            display: flex;
            align-items: center;
            gap: 8px; /* Add gap for consistent spacing */
        }
        /* Ë§áË£Ω Gateway ÂÖßÂµåË°®ÂñÆÊ®£Âºè */
        .copy-form-container {
            display: none;
            margin: 15px 0;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .copy-form-container.show {
            display: block;
        }
        .copy-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .copy-form input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.95em;
        }
        .copy-form-buttons {
            display: flex;
            gap: 8px;
        }
        /* Âà™Èô§Á¢∫Ë™çÂΩàÁ™óÊ®£Âºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #dc3545;
        }
        .modal-body {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .endpoint-text {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
            white-space: nowrap;
        }
        .endpoint-code {
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <h1>MCP Composer Management Interface</h1>
    <div id="gateways-container"></div>
    <div id="notification" class="notification"></div>
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">Confirm Deletion</div>
            <div class="modal-body">Are you sure you want to delete this Gateway? This action cannot be undone.</div>
            <div class="modal-footer">
                <button id="cancel-delete-btn" class="copy-btn">Cancel</button>
                <button id="confirm-delete-btn" class="disable-btn">Confirm Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/v1'; // Define API base URL

        // --- Notification System ---
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            setTimeout(() => notification.classList.add('show'), 10); // Fade in
            setTimeout(() => notification.classList.remove('show'), duration); // Fade out
        }

        // --- API Call Helper ---
        async function apiCall(endpoint, method = 'GET', body = null, button = null) {
            let originalButtonText = '';
            if (button) {
                originalButtonText = button.textContent;
                button.classList.add('button-loading');
                button.disabled = true;
            }

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);

                if (!response.ok) {
                    let errorMsg = `HTTP Error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg += ` - ${errorData.detail || JSON.stringify(errorData)}`;
                    } catch (e) { /* Ignore if response body is not JSON */ }
                    throw new Error(errorMsg);
                }
                
                // For methods other than GET, try to parse JSON, otherwise return raw response
                if (method !== 'GET' && response.headers.get("content-type")?.includes("application/json")) {
                    return await response.json();
                }
                // For GET requests or non-JSON responses, return the parsed JSON or the raw response
                return method === 'GET' ? await response.json() : response;

            } catch (error) {
                console.error(`API Call Error (${method} ${endpoint}):`, error);
                showNotification(`Operation failed: ${error.message}`, 'error', 5000);
                throw error; // Re-throw error to be handled by caller if needed
            } finally {
                if (button) {
                    button.classList.remove('button-loading');
                    // Only re-enable if not part of a full refresh
                    // We'll handle re-enabling implicitly by reloading data
                    // button.disabled = false; 
                    // button.textContent = originalButtonText; // Restore text if needed, but refresh handles it
                }
            }
        }

        // --- Gateway Functions ---
        async function fetchGateways() {
            // Make this function just return data, not modify button state
            return apiCall('/gateways');
        }

        async function fetchSpecificGateway(gatewayName) {
            // Helper function to fetch a single gateway's data
            // Assumes an endpoint like /gateways/{name} exists, or filters from /gateways
            // For simplicity, let's filter from /gateways for now
            try {
                const allGateways = await apiCall('/gateways'); // Use raw apiCall
                const gateway = allGateways.find(g => g.name === gatewayName);
                if (!gateway) {
                     throw new Error(`Gateway '${gatewayName}' not found.`);
                }
                return gateway;
            } catch (error) {
                 console.error(`Failed to fetch specific gateway ${gatewayName}:`, error);
                 throw error; // Re-throw to be caught by caller
            }
        }

        async function copyGateway(gatewayNameToCopy, button, newName = null) { 
            let originalButtonText = '';
            if (button) {
                 originalButtonText = button.textContent;
                 button.disabled = true;
            }

            // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÈ°ØÁ§∫Ë°®ÂñÆÔºåÂ¶ÇÊûúÊòØÔºåÂ∞±Èö±Ëóè‰∏¶ÈáçË®≠ÊåâÈàï
            const gatewayCard = button.closest('.gateway-card');
            const existingForm = gatewayCard.querySelector('.copy-form-container');
            
            if (existingForm && existingForm.classList.contains('show') && !newName) {
                existingForm.classList.remove('show');
                if (button) {
                    button.disabled = false;
                }
                return;
            }

            // Â¶ÇÊûúÊèê‰æõ‰∫ÜÊñ∞ÂêçÁ®±ÔºåË°®Á§∫ÈÄôÊòØË°®ÂñÆÊèê‰∫§ÔºåÂü∑Ë°åÂØ¶ÈöõË§áË£ΩÊìç‰Ωú
            if (newName) {
                button.classList.add('button-loading');
                
                try {
                    // Áç≤ÂèñÊúÄÊñ∞ÁöÑ gateway ÁãÄÊÖã
                    const gatewayToCopy = await fetchSpecificGateway(gatewayNameToCopy);
                    
                    if (newName === gatewayToCopy.name) {
                        showNotification('New Gateway name cannot be the same as the source', 'error');
                        button.classList.remove('button-loading');
                        button.disabled = false;
                        return;
                    }

                    const requestBody = {
                        name: newName.trim(),
                        server_kit: gatewayToCopy.server_kit
                    };

                    await apiCall('/gateways', 'POST', requestBody, button);
                    showNotification(`Gateway "${newName}" copied successfully`, 'success');
                    
                    // Èö±ËóèË°®ÂñÆ‰∏¶Âà∑Êñ∞ÂàóË°®
                    if (existingForm) {
                        existingForm.classList.remove('show');
                    }
                    loadGateways();
                } catch (error) {
                    if (button) {
                        button.classList.remove('button-loading');
                        button.disabled = false;
                    }
                }
                return;
            }

            // Â¶ÇÊûúÊ≤íÊúâÊèê‰æõÊñ∞ÂêçÁ®±ÔºåÈ°ØÁ§∫Ëº∏ÂÖ•Ë°®ÂñÆ
            let formContainer;
            if (!existingForm) {
                formContainer = document.createElement('div');
                formContainer.className = 'copy-form-container';
                
                const form = document.createElement('div');
                form.className = 'copy-form';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Enter new Gateway name (copy of ${gatewayNameToCopy})`;
                input.name = 'newGatewayName';
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'copy-form-buttons';
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'enable-btn';
                confirmBtn.textContent = 'Confirm';
                confirmBtn.addEventListener('click', () => {
                    if (input.value && input.value.trim() !== '') {
                        copyGateway(gatewayNameToCopy, confirmBtn, input.value.trim());
                    } else {
                        showNotification('Please enter a valid Gateway name', 'error');
                    }
                });
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'disable-btn';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.addEventListener('click', () => {
                    formContainer.classList.remove('show');
                    button.disabled = false;
                });
                
                buttonsDiv.appendChild(confirmBtn);
                buttonsDiv.appendChild(cancelBtn);
                
                form.appendChild(input);
                form.appendChild(buttonsDiv);
                formContainer.appendChild(form);
                
                // ÊèíÂÖ•Âà∞ÊåâÈàï‰∏ãÊñπ
                const gatewayHeader = button.closest('.gateway-header');
                gatewayCard.insertBefore(formContainer, gatewayHeader.nextSibling);
            } else {
                formContainer = existingForm;
                // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê¨Ñ‰Ωç
                const input = formContainer.querySelector('input');
                if (input) {
                    input.value = '';
                }
            }
            
            formContainer.classList.add('show');
        }

        async function deleteGateway(gatewayName, button) {
            // È°ØÁ§∫Á¢∫Ë™çÂΩàÁ™óËÄå‰∏çÊòØ‰ΩøÁî® confirm
            const modal = document.getElementById('delete-modal');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            const cancelBtn = document.getElementById('cancel-delete-btn');
            const modalBody = modal.querySelector('.modal-body');
            
            // Êõ¥Êñ∞ÂΩàÁ™óÂÖßÂÆπ‰ª•ÂåÖÂê´ Gateway ÂêçÁ®±
            modalBody.textContent = `Are you sure you want to delete Gateway "${gatewayName}"? This action cannot be undone.`;
            
            // È°ØÁ§∫ÂΩàÁ™ó
            modal.classList.add('show');
            
            // Ë®≠ÁΩÆÊåâÈàï‰∫ã‰ª∂ËôïÁêÜÂô®
            const confirmDelete = async () => {
                // ÁßªÈô§‰∫ã‰ª∂Áõ£ËÅΩÂô®
                confirmBtn.removeEventListener('click', confirmDelete);
                cancelBtn.removeEventListener('click', cancelDeleteModal);
                
                // Èö±ËóèÂΩàÁ™ó
                modal.classList.remove('show');
                
                let originalButtonText = '';
                if (button) {
                    originalButtonText = button.textContent;
                    button.classList.add('button-loading');
                    button.disabled = true;
                }

                try {
                    // ÂëºÂè´ DELETE Á´ØÈªû
                    await apiCall(`/gateways/${gatewayName}`, 'DELETE', null, button);
                    showNotification(`Gateway "${gatewayName}" deleted successfully`, 'success');
                    loadGateways(); // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®
                } catch (error) {
                    // apiCall ‰∏≠Â∑≤ËôïÁêÜÈåØË™§ÈÄöÁü•
                    // Âú®Â§±ÊïóÊôÇÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖãÔºàÂ¶ÇÊûú loadGateways Ê≤íÊúâÈÅãË°åÔºâ
                    if (button) {
                        button.classList.remove('button-loading');
                        button.disabled = false; // ÈáçÊñ∞ÂïüÁî®ÊåâÈàï
                        button.textContent = originalButtonText;
                    }
                }
            };
            
            const cancelDeleteModal = () => {
                // ÁßªÈô§‰∫ã‰ª∂Áõ£ËÅΩÂô®
                confirmBtn.removeEventListener('click', confirmDelete);
                cancelBtn.removeEventListener('click', cancelDeleteModal);
                
                // Èö±ËóèÂΩàÁ™ó
                modal.classList.remove('show');
            };
            
            // Ê∑ªÂä†ÊåâÈàï‰∫ã‰ª∂
            confirmBtn.addEventListener('click', confirmDelete);
            cancelBtn.addEventListener('click', cancelDeleteModal);
        }

        // --- Server/Tool Status Toggle Functions ---
        async function toggleServerStatus(kitName, serverName, enable, button) {
            const action = enable ? 'enable' : 'disable';
            try {
                const updatedKit = await apiCall(`/kits/${kitName}/servers/${serverName}/${action}`, 'POST', null, button);
                showNotification(`Server ${serverName} ${enable ? 'enabled' : 'disabled'} successfully`, 'success');
                updateServerAndToolsUI(kitName, serverName, updatedKit);
            } catch (error) {
                button.disabled = false;
                button.classList.remove('button-loading');
                showNotification(`Failed to ${enable ? 'enable' : 'disable'} server ${serverName}`, 'error');
            }
        }

        async function toggleToolStatus(kitName, toolName, enable, button) {
             const action = enable ? 'enable' : 'disable';
             try {
                 const updatedKit = await apiCall(`/kits/${kitName}/tools/${toolName}/${action}`, 'POST', null, button);
                 showNotification(`Tool ${toolName} ${enable ? 'enabled' : 'disabled'} successfully`, 'success');
                 updateToolUI(kitName, toolName, updatedKit);
             } catch (error) {
                 button.disabled = false;
                 button.classList.remove('button-loading');
                 showNotification(`Failed to ${enable ? 'enable' : 'disable'} tool ${toolName}`, 'error');
             }
        }

        // --- UI Update Functions ---
        function updateServerAndToolsUI(kitName, serverName, updatedKit) {
            const gatewayCard = document.querySelector(`.gateway-card .server-kit-details[data-kit-name="${kitName}"]`)?.closest('.gateway-card');
            if (!gatewayCard) return; // Should not happen if button exists

            const serverCard = gatewayCard.querySelector(`.server-card[data-server-name="${serverName}"]`);
            if (!serverCard) return;

            const isServerNowEnabled = updatedKit.servers_enabled[serverName] ?? false;

            // Update Server Status Badge and Button
            const serverStatusBadge = serverCard.querySelector('.server-header .status-badge');
            const serverToggleButton = serverCard.querySelector('.server-header button.disable-btn, .server-header button.enable-btn');

            serverStatusBadge.textContent = isServerNowEnabled ? 'Enabled' : 'Disabled';
            serverStatusBadge.className = `status-badge ${isServerNowEnabled ? 'status-enabled' : 'status-disabled'}`;

            serverToggleButton.textContent = isServerNowEnabled ? 'Disable' : 'Enable';
            serverToggleButton.className = isServerNowEnabled ? 'disable-btn' : 'enable-btn';
            // Re-attach onclick to update the 'enable' parameter for the next click
            serverToggleButton.onclick = (e) => toggleServerStatus(kitName, serverName, !isServerNowEnabled, e.target);
            serverToggleButton.disabled = false; // Ensure button is re-enabled
            serverToggleButton.classList.remove('button-loading');

            // Update Tools within this Server
            const toolsForServer = updatedKit.servers_tools_hierarchy_map[serverName] || [];
            toolsForServer.forEach(toolName => {
                const toolItem = serverCard.querySelector(`.tool-item[data-tool-name="${toolName}"]`);
                if (!toolItem) return;

                const isToolEnabled = updatedKit.tools_enabled[toolName] ?? false;

                // Update Tool Status Badge and Button
                const toolStatusBadge = toolItem.querySelector('.status-badge');
                const toolToggleButton = toolItem.querySelector('button.disable-btn, button.enable-btn');

                toolStatusBadge.textContent = isToolEnabled ? 'Enabled' : 'Disabled';
                toolStatusBadge.className = `status-badge ${isToolEnabled ? 'status-enabled' : 'status-disabled'}`;

                toolToggleButton.textContent = isToolEnabled ? 'Disable' : 'Enable';
                toolToggleButton.className = isToolEnabled ? 'disable-btn' : 'enable-btn';
                toolToggleButton.disabled = !isServerNowEnabled; // Disable tool button if server is disabled
                 // Re-attach onclick to update the 'enable' parameter for the next click
                toolToggleButton.onclick = (e) => toggleToolStatus(kitName, toolName, !isToolEnabled, e.target);
                toolToggleButton.classList.remove('button-loading');

                // Add/Remove grayed-out class based on server status
                if (isServerNowEnabled) {
                    toolItem.classList.remove('grayed-out');
                } else {
                    toolItem.classList.add('grayed-out');
                }
            });
        }

        function updateToolUI(kitName, toolName, updatedKit) {
            const gatewayCard = document.querySelector(`.gateway-card .server-kit-details[data-kit-name="${kitName}"]`)?.closest('.gateway-card');
            if (!gatewayCard) return;

            const toolItem = gatewayCard.querySelector(`.tool-item[data-tool-name="${toolName}"]`);
            if (!toolItem) return;

            const isToolNowEnabled = updatedKit.tools_enabled[toolName] ?? false;
            const serverCard = toolItem.closest('.server-card');
            const serverName = serverCard?.dataset.serverName;
            const isServerEnabled = serverName ? (updatedKit.servers_enabled[serverName] ?? false) : true; // Assume server enabled if not found?

            // Update Tool Status Badge and Button
            const toolStatusBadge = toolItem.querySelector('.status-badge');
            const toolToggleButton = toolItem.querySelector('button.disable-btn, button.enable-btn');

            toolStatusBadge.textContent = isToolNowEnabled ? 'Enabled' : 'Disabled';
            toolStatusBadge.className = `status-badge ${isToolNowEnabled ? 'status-enabled' : 'status-disabled'}`;

            toolToggleButton.textContent = isToolNowEnabled ? 'Disable' : 'Enable';
            toolToggleButton.className = isToolNowEnabled ? 'disable-btn' : 'enable-btn';
            toolToggleButton.disabled = !isServerEnabled; // Still depends on server status
            // Re-attach onclick to update the 'enable' parameter for the next click
            toolToggleButton.onclick = (e) => toggleToolStatus(kitName, toolName, !isToolNowEnabled, e.target);
            toolToggleButton.classList.remove('button-loading');

            // Gray-out state depends on server, which shouldn't change here, so no need to update toolItem classlist.
        }

        // --- Rendering Functions ---
        function createToolItem(kitName, toolName, toolsEnabledMap, isServerEnabled) {
             const toolItem = document.createElement('div');
             toolItem.className = 'tool-item';
             toolItem.dataset.toolName = toolName; // Add data attribute
             if (!isServerEnabled) {
                 toolItem.classList.add('grayed-out'); // Gray out if server is disabled
             }

             const toolNameEl = document.createElement('div');
             toolNameEl.textContent = toolName;

             const toolStatusAndButton = document.createElement('div');
             toolStatusAndButton.style.display = 'flex';
             toolStatusAndButton.style.alignItems = 'center';

             const toolStatus = document.createElement('span');
             const isToolEnabled = toolsEnabledMap[toolName] ?? false; // Get status from the map
             toolStatus.className = `status-badge ${isToolEnabled ? 'status-enabled' : 'status-disabled'}`;
             toolStatus.textContent = isToolEnabled ? 'Enabled' : 'Disabled';

             const toolToggleButton = document.createElement('button');
             toolToggleButton.className = isToolEnabled ? 'disable-btn' : 'enable-btn';
             toolToggleButton.textContent = isToolEnabled ? 'Disable' : 'Enable';
             toolToggleButton.disabled = !isServerEnabled; // Disable button if server is disabled
             toolToggleButton.onclick = (e) => toggleToolStatus(kitName, toolName, !isToolEnabled, e.target);

             toolStatusAndButton.appendChild(toolStatus);
             toolStatusAndButton.appendChild(toolToggleButton);

             toolItem.appendChild(toolNameEl);
             toolItem.appendChild(toolStatusAndButton);
             // Add class to the button group div
             toolStatusAndButton.classList.add('status-and-button-group');

             return toolItem;
        }

        function createServerCard(kitName, serverName, toolsEnabledMap, serversToolsMap, isServerEnabled) {
            const serverCard = document.createElement('div');
            serverCard.className = 'server-card';
            serverCard.dataset.serverName = serverName; // Add data attribute
            if (!isServerEnabled) {
                // serverCard.classList.add('grayed-out'); // Apply gray out to the whole card or just tools? Let's do tools.
            }

            const serverHeader = document.createElement('div');
            serverHeader.className = 'server-header';

            const serverNameAndToggle = document.createElement('div');
             serverNameAndToggle.style.display = 'flex';
             serverNameAndToggle.style.alignItems = 'center';

            // Toggle button for tools
             const toggleToolsBtn = document.createElement('button');
             toggleToolsBtn.className = 'toggle-details-btn';
             toggleToolsBtn.title = 'Show/Hide Tools';
             toggleToolsBtn.onclick = () => {
                 toolList.classList.toggle('expanded');
                 toggleToolsBtn.classList.toggle('expanded');
             };

            const serverNameEl = document.createElement('div');
            serverNameEl.className = 'server-name';
            serverNameEl.textContent = serverName;
            serverNameEl.style.marginLeft = '5px'; // Space after toggle arrow

            serverNameAndToggle.appendChild(toggleToolsBtn);
             serverNameAndToggle.appendChild(serverNameEl);


            const serverStatusAndButton = document.createElement('div');
             serverStatusAndButton.style.display = 'flex';
             serverStatusAndButton.style.alignItems = 'center';

            const serverStatus = document.createElement('span');
            serverStatus.className = `status-badge ${isServerEnabled ? 'status-enabled' : 'status-disabled'}`;
            serverStatus.textContent = isServerEnabled ? 'Enabled' : 'Disabled';

            const serverToggleButton = document.createElement('button');
            serverToggleButton.className = isServerEnabled ? 'disable-btn' : 'enable-btn';
            serverToggleButton.textContent = isServerEnabled ? 'Disable' : 'Enable';
            serverToggleButton.onclick = (e) => toggleServerStatus(kitName, serverName, !isServerEnabled, e.target);

            serverStatusAndButton.appendChild(serverStatus);
            serverStatusAndButton.appendChild(serverToggleButton);

            serverHeader.appendChild(serverNameAndToggle);
            serverHeader.appendChild(serverStatusAndButton);
            // Add class to the button group div
            serverStatusAndButton.classList.add('status-and-button-group');
            serverCard.appendChild(serverHeader);

            // Tool List (initially hidden)
            const toolList = document.createElement('div');
            toolList.className = 'tool-list'; // Initially hidden via CSS
            const toolsForServer = serversToolsMap[serverName] || [];

            if (toolsForServer.length > 0) {
                toolsForServer.forEach(toolName => {
                    // Pass toolsEnabledMap instead of non-existent toolData
                    toolList.appendChild(createToolItem(kitName, toolName, toolsEnabledMap, isServerEnabled));
                });
            } else {
                const noTools = document.createElement('div');
                noTools.textContent = 'No tools for this server';
                noTools.style.fontStyle = 'italic';
                noTools.style.fontSize = '0.9em';
                noTools.style.color = '#6c757d';
                noTools.style.padding = '10px 0';
                toolList.appendChild(noTools);
                 // Hide toggle button if no tools
                 toggleToolsBtn.style.visibility = 'hidden';
            }
            serverCard.appendChild(toolList);

            return serverCard;
        }


        function createServerKitDetails(gateway) {
             const kit = gateway.server_kit;
             const detailsSection = document.createElement('div');
             detailsSection.className = 'details-section server-kit-details'; // Add class for easier selection
             detailsSection.dataset.kitName = kit.name; // Add data attribute

             const kitHeader = document.createElement('div');
             kitHeader.className = 'server-kit-header';
             const kitNameEl = document.createElement('div');
             kitNameEl.className = 'server-kit-name';
             kitNameEl.textContent = `Server Kit: ${kit.name}`;
             kitHeader.appendChild(kitNameEl);
             // Maybe add kit-level enable/disable later if needed
             detailsSection.appendChild(kitHeader);

            // Process servers based on the server_kit structure
            const serversContainer = document.createElement('div');
            const serverNames = Object.keys(kit.servers_tools_hierarchy_map || {});

            if (serverNames.length > 0) {
                 serverNames.forEach(serverName => {
                    // Check if server exists in servers (though map should be the source of truth?)
                    // const serverData = kit.servers[serverName]; // REMOVE: kit.servers doesn't exist
                     const isServerEnabled = kit.servers_enabled[serverName] ?? false; // Default to false if missing
                    // Always render the server card based on servers_tools_hierarchy_map keys
                    serversContainer.appendChild(
                         // Pass tools_enabled map instead of non-existent kit.tools
                         createServerCard(kit.name, serverName, kit.tools_enabled, kit.servers_tools_hierarchy_map, isServerEnabled)
                    );
                 });
            } else {
                 serversContainer.innerHTML = '<div class="no-data">No servers in this Server Kit</div>';
            }

             detailsSection.appendChild(serversContainer);
             return detailsSection;
        }

        function createGatewayCard(gateway) {
            const card = document.createElement('div');
            card.className = 'gateway-card';

            const header = document.createElement('div');
            header.className = 'gateway-header';

            const nameAndPaths = document.createElement('div');
            const name = document.createElement('div');
            name.className = 'gateway-name';
            name.textContent = gateway.name;
            nameAndPaths.appendChild(name);

            const paths = document.createElement('div');
            paths.className = 'gateway-paths';
            
            // Create endpoint row with copy button and endpoint
            const endpointRow = document.createElement('div');
            endpointRow.className = 'endpoint-row';
            
            // Create endpoint text with embedded copy button
            const endpointText = document.createElement('div');
            endpointText.className = 'endpoint-text';
            
            // Create copy button
            const copyEndpointBtn = document.createElement('button');
            copyEndpointBtn.className = 'copy-endpoint-btn';
            copyEndpointBtn.textContent = 'Copy';
            copyEndpointBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent event bubbling
                navigator.clipboard.writeText(gateway.gateway_endpoint)
                    .then(() => showNotification('Endpoint copied to clipboard!', 'success', 2000))
                    .catch(err => showNotification('Failed to copy: ' + err, 'error', 3000));
            };
            
            const endpointLabel = document.createTextNode('Endpoint: ');
            const endpointCode = document.createElement('code');
            endpointCode.className = 'endpoint-code';
            endpointCode.textContent = gateway.gateway_endpoint;
            
            // Create description (bracketed content now on a new line)
            const endpointDescription = document.createElement('div');
            endpointDescription.className = 'endpoint-description';
            endpointDescription.textContent = 'This is the MCP server endpoint. Please connect to this endpoint.';
            
            // Combine elements
            endpointText.appendChild(endpointLabel);
            endpointText.appendChild(copyEndpointBtn);
            endpointText.appendChild(endpointCode);
            endpointRow.appendChild(endpointText);
            
            paths.appendChild(endpointRow);
            paths.appendChild(endpointDescription);
            
            nameAndPaths.appendChild(paths);

            const buttons = document.createElement('div');
            // Add class to the button group div
            buttons.classList.add('button-group');
             // Toggle Server Kit Button
             const toggleKitBtn = document.createElement('button');
             toggleKitBtn.className = 'action-btn';
             toggleKitBtn.textContent = 'Show Server Kit';
             toggleKitBtn.onclick = () => {
                 const details = card.querySelector('.details-section');
                 details.classList.toggle('expanded');
                 toggleKitBtn.textContent = details.classList.contains('expanded') ? 'Hide Server Kit' : 'Show Server Kit';
             };
             buttons.appendChild(toggleKitBtn);

            // Copy Button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy Gateway';
            // Pass gateway name instead of the full object
            copyBtn.onclick = (e) => copyGateway(gateway.name, e.target);
            buttons.appendChild(copyBtn);

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'disable-btn'; // Use red color for delete
            deleteBtn.textContent = 'Delete Gateway';
            deleteBtn.onclick = (e) => deleteGateway(gateway.name, e.target);
            buttons.appendChild(deleteBtn);


            header.appendChild(nameAndPaths);
            header.appendChild(buttons);
            card.appendChild(header);

            // Server Kit Details (initially hidden)
            const serverKitDetails = createServerKitDetails(gateway);
            card.appendChild(serverKitDetails);


            return card;
        }

        async function loadGateways() {
            const container = document.getElementById('gateways-container');
            if (!container) return;
            container.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const gateways = await fetchGateways();
                console.log('Received gateways:', JSON.stringify(gateways, null, 2));
                container.innerHTML = ''; // Clear loading message

                if (!gateways || gateways.length === 0) {
                    container.innerHTML = '<div class="no-data">No available Gateways</div>';
                    return;
                }

                gateways.sort((a, b) => a.name.localeCompare(b.name)); // Sort gateways by name

                gateways.forEach(gateway => {
                    if (gateway && gateway.name && gateway.server_kit) { // Basic validation
                        container.appendChild(createGatewayCard(gateway));
                    } else {
                         console.warn("Received invalid gateway data:", gateway);
                    }
                });
            } catch (error) {
                container.innerHTML = '<div class="no-data">Error loading Gateways. Please check the console or try again later.</div>';
                // Error notification is handled in fetchGateways -> apiCall
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadGateways);
    </script>
</body>
</html>
